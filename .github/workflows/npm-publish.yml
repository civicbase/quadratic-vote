name: Publish to npm (OIDC)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag to publish (example: v2.1.0). If empty, you must run this workflow on a tag ref."
        required: false
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"
          # Avoid generating a token-ish .npmrc (always-auth/_authToken). OIDC publish doesn't need it.

      # npm Trusted Publishing (OIDC) requires a newer npm CLI.
      - name: Upgrade npm for Trusted Publishing
        run: |
          npm i -g npm@^11.5.1
          npm -v

      - name: Prepare clean npm config for OIDC publish
        run: |
          echo "" > "${GITHUB_WORKSPACE}/.npmrc.oidc"

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build

      - name: Set package version from git tag
        run: |
          # Prefer explicit input if provided (useful for workflow_dispatch)
          TAG_INPUT="${{ inputs.tag }}"
          REF_NAME="${GITHUB_REF_NAME}"

          if [[ -n "$TAG_INPUT" ]]; then
            REF_NAME="$TAG_INPUT"
          fi

          if [[ "$REF_NAME" != v* ]]; then
            echo "This workflow must run on a version tag (vX.Y.Z)."
            echo "You ran it on ref: '$GITHUB_REF_NAME'."
            echo "Re-run and select a tag ref, or provide inputs.tag (example: v2.1.0)."
            exit 1
          fi

          VERSION="${REF_NAME#v}"
          echo "Publishing version: $VERSION (from tag $REF_NAME)"
          npm version "$VERSION" --no-git-tag-version

      - name: Publish
        env:
          NPM_CONFIG_PROVENANCE: "true"
          NPM_CONFIG_USERCONFIG: ${{ github.workspace }}/.npmrc.oidc
          NPM_CONFIG_REGISTRY: https://registry.npmjs.org/
        run: npm publish --access public


