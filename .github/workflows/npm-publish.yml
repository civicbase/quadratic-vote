name: Publish to npm (OIDC)

on:
  # NOTE: Tag pushes created by workflows (semantic-release using GITHUB_TOKEN) do NOT trigger
  # other workflows via `on: push` due to GitHub recursion protections.
  # So we trigger off the Release workflow completion instead.
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag to publish (example: v2.1.0). If empty, you must run this workflow on a tag ref."
        required: false
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"
          # Avoid generating a token-ish .npmrc (always-auth/_authToken). OIDC publish doesn't need it.

      # npm Trusted Publishing (OIDC) requires a newer npm CLI.
      - name: Upgrade npm for Trusted Publishing
        run: |
          npm i -g npm@^11.5.1
          npm -v

      - name: Prepare clean npm config for OIDC publish
        run: |
          echo "" > "${GITHUB_WORKSPACE}/.npmrc.oidc"

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build

      - name: Determine tag to publish
        id: tag
        run: |
          # Prefer explicit input if provided (useful for workflow_dispatch).
          TAG_INPUT="${{ inputs.tag }}"

          if [[ -n "$TAG_INPUT" ]]; then
            TAG="$TAG_INPUT"
          else
            # When triggered by workflow_run, publish the newest v* tag reachable from that run's SHA.
            SHA="${{ github.event.workflow_run.head_sha }}"
            TAG="$(git describe --tags --abbrev=0 --match 'v*' "$SHA" 2>/dev/null || true)"
          fi

          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "No version tag (vX.Y.Z) found to publish."
            echo "If running manually, provide inputs.tag (example: v2.1.0)."
            exit 1
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Will publish tag: $TAG"

      - name: Set package version from tag
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          VERSION="${TAG#v}"
          echo "Publishing version: $VERSION (from tag $TAG)"
          npm version "$VERSION" --no-git-tag-version

      - name: Publish
        env:
          NPM_CONFIG_PROVENANCE: "true"
          NPM_CONFIG_USERCONFIG: ${{ github.workspace }}/.npmrc.oidc
          NPM_CONFIG_REGISTRY: https://registry.npmjs.org/
        run: npm publish --access public


